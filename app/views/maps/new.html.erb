<div class="col-sm-12 col-md-8 col-lg-5">
<h2>gmap</h2>
<input id="address" type="textbox" >
<input type="button" value="Encode" onclick="codeAddress()">


<div class="d-flex">
<div>
<div id='map'></div>

<style>
#map {
  height: 600px;
  width: 600px;
}
</style>

<script>
let map;
let geocoder;
const display = document.getElementById('display');
let marker = null; // マーカーを保持する変数
let lastPlaceMarker = null; // 最新の投稿のマーカーを保持する変数

function initMap() {
  geocoder = new google.maps.Geocoder();

  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 40.7828, lng: -73.9653 },
    zoom: 14,
  });

  <% if @last_place.present? %>
    var lastPlace = {
      latitude: <%= @last_place.latitude %>,
      longitude: <%= @last_place.longitude %>,
      name: '<%= @last_place.name %>',
      createdAt: '<%= @last_place.created_at.strftime('%Y/%m/%d') %>'
    };

    lastPlaceMarker = new google.maps.Marker({
      position: { lat: lastPlace.latitude, lng: lastPlace.longitude },
      map: map,
      title: lastPlace.name
    });

    var infoWindow = new google.maps.InfoWindow({
      content: '<h3>' + lastPlace.name + '</h3>' +
               '<p><%= attachment_image_tag @last_place, :image, :fill, 100, 100, format: 'jpeg' %></p>'+
               '<h4>' + lastPlace.createdAt + '</h4>' 
    });

    lastPlaceMarker.addListener('click', function() {
      infoWindow.open(map, lastPlaceMarker);
    });

    map.setCenter({ lat: lastPlace.latitude, lng: lastPlace.longitude });
  <% end %>

  // ...（他のマーカーの処理）...
}

function codeAddress() {
  if (marker) {
    marker.setMap(null); // 前回のマーカーを削除
  }
  
  if (lastPlaceMarker) {
    lastPlaceMarker.setMap(null); // lastPlace のマーカーを削除
  }

  let inputAddress = document.getElementById('address').value;

  geocoder.geocode({ 'address': inputAddress }, function(results, status) {
  if (status == 'OK') {
    var latitude = results[0].geometry.location.lat();
    var longitude = results[0].geometry.location.lng();

    map.setCenter(results[0].geometry.location);
    marker = new google.maps.Marker({
      map: map,
      position: results[0].geometry.location
    });
    
    // 緯度と経度をテキストフィールドにセット
    document.getElementById('latitude').value = latitude;
    document.getElementById('longitude').value = longitude;
    
    
  } else {
    alert('該当する結果がありませんでした：' + status);
  }
});
 
}

// Google Maps APIの読み込み
var script = document.createElement('script');
script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDtURyIrXDlqiIj0KdKOuCtWuQGfzHAwBQ&callback=initMap';
script.defer = true;
script.async = true;
document.head.appendChild(script);

</script>
</div>
<div>
  
<%= form_with(model: @place, url: maps_path, local: true) do |form| %>
  <!-- フォームの内容 -->
  <%= form.label :name %>
  <%= form.text_field :name %>
  <div>
  <%= form.label :comment %>
  <%= form.text_field :body %>

  <!-- 緯度と経度の隠しフィールド -->
  <%= form.hidden_field :latitude, id: 'latitude' %>
  <%= form.hidden_field :longitude, id: 'longitude' %>
</div>
<div>
  <%= form.label :image %>
  <%= form.attachment_field :image %>
</div>
  <%= form.submit %>
<% end %>
</div>
</div>
</div>